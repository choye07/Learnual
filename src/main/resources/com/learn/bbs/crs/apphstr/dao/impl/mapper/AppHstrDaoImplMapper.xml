<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.learn.bbs.crs.apphstr.dao.impl.AppHstrDaoImpl">
    <insert id="insertOneAppHstr">
        <selectKey keyProperty="appHstrId" resultType="string" order="BEFORE">
            SELECT 'APP_HSTR-' || TO_CHAR(SYSDATE, 'YYYYMMDD') || '-' || LPAD(SEQ_APP_HSTR_PK.NEXTVAL, 6, '0') FROM DUAL
        </selectKey>
        INSERT INTO APP_HSTR (
        APP_HSTR_ID,
        APP_HSTR_RGST_DT,
        CRS_INF_ID,
        USR_ID
    ) VALUES (
        #{appHstrId},
        SYSDATE,
        #{crsInfId},
        #{usrId}
    )
    </insert>
    
    <select id="existsAppHstr" resultType="boolean">
        SELECT CASE 
             WHEN COUNT(*) > 0 THEN 1 
             ELSE 0 
           END AS result
          FROM APP_HSTR
         WHERE CRS_INF_ID = #{crsInfId}
           AND USR_ID = #{usrId}
    </select>
    
    <select id="findAppHstrId" resultType="string">
        SELECT MAX(APP_HSTR_ID)
          FROM APP_HSTR
         WHERE CRS_INF_ID = #{crsInfId}
           AND USR_ID = #{usrId}
    </select>
</mapper>